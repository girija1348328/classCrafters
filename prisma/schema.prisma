generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"

  url = env("DATABASE_URL")
}

model Role {
  id Int @id @default(autoincrement())

  name String

  description String?

  users User[]
}

model User {
  id            Int    @id @default(autoincrement())
  name          String
  email         String @unique
  password_hash String

  role_id Int
  role    Role @relation(fields: [role_id], references: [id])

  studentRegs StudentRegistration[]
  staffRegs   StaffRegistration[]

  classrooms        Classroom[]
  classroomStudents ClassroomStudent[]
  submissions       Submission[]

  chatParticipant ChatParticipant[]
  chatMessage     ChatMessage[]

  assignedFeeAssignments FeeAssignment[] @relation("AssignedByUser")
  receivedPayments       FeePayment[]    @relation("ReceivedByUser")

  // Correct Back Relations
  punchIns  StaffAttendance[] @relation("PunchInByRelation")
  punchOuts StaffAttendance[] @relation("PunchOutByRelation")

  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  studentAttendances StudentAttendance[]

  quizzes  Quiz[]        @relation("AdminQuizzes")
  attempts QuizAttempt[]
  enquiry Enquiry[]


  leaveRequests LeaveRequest[] @relation("LeaveApplicant")
  leaveReviews  LeaveRequest[] @relation("LeaveReviewer")
}

model EducationType {
  id Int @id @default(autoincrement())

  name String

  institutions Institution[]
}

model Location {
  id Int @id @default(autoincrement())

  name String

  address String?

  city String?

  state String?

  country String?

  zipcode String?

  institutions Institution[]
}

model Institution {
  id Int @id @default(autoincrement())

  name String

  education_type_id Int

  location_id Int

  educationType EducationType @relation(fields: [education_type_id], references: [id])

  location Location @relation(fields: [location_id], references: [id])

  studentRegs StudentRegistration[]

  staffRegs StaffRegistration[]

  feeHeads FeeHead[]

  feeStructures FeeStructure[]

  staffAttendance StaffAttendance[]

  created_at DateTime @default(now())

  updated_at DateTime @updatedAt
}

model Phase {
  id Int @id @default(autoincrement())

  name String

  description String?

  studentRegs StudentRegistration[]

  feeStructures FeeStructure[]
}

model MainGroup {
  id Int @id @default(autoincrement())

  name String

  description String?

  subGroups SubGroup[]
}

model SubGroup {
  id Int @id @default(autoincrement())

  name String

  main_group_id Int

  mainGroup MainGroup @relation(fields: [main_group_id], references: [id])

  studentRegs StudentRegistration[]

  feeStructures FeeStructure[]
}

model CustomField {
  id Int @id @default(autoincrement())

  name String

  entity_type String // "student_registration" or "staff_registration"

  field_type String // text, number, date, dropdown

  options Json?
}

model StudentRegistration {
  id Int @id @default(autoincrement())

  student_id Int

  rollNumber Int?

  academic_sessionId Int

  classroom_id Int

  section_id Int

  user_id Int

  institution_id Int

  phase_id Int

  subgroup_id Int

  custom_data Json?

  student Student @relation(fields: [student_id], references: [id])

  academicSession   AcademicSession  @relation(fields: [academic_sessionId], references: [id])

  class             Classroom           @relation(fields: [classroom_id], references: [id])

  section           Section          @relation(fields: [section_id], references: [id])

  user User @relation(fields: [user_id], references: [id])

  institution Institution @relation(fields: [institution_id], references: [id])

  phase Phase @relation(fields: [phase_id], references: [id])

  subgroup SubGroup @relation(fields: [subgroup_id], references: [id])

  status AdmissionStatus

  feeAssignments FeeAssignment[]

  feePayments FeePayment[]

  studentAttendance StudentAttendance[]

  created_at DateTime @default(now())
}


model Student{
  id Int @id @default(autoincrement())
  admissionNo Int @unique
  firstName String
  lastName String 
  gender Gender
  dob DateTime
  bloodGroup String
  email String
  phone String
  address String

  parent Parent?
  admissions StudentRegistration[]
  documents StudentDocument[]

  created_at DateTime @default(now())
  updated_at DateTime @default(now())

}

model StudentDocument {
  id          Int          @id @default(autoincrement())
  studentId   Int
  type        DocumentType
  fileUrl     String
  student     Student      @relation(fields: [studentId], references: [id])
  uploadedAt  DateTime     @default(now())
}

model Parent{
  id Int @id @default(autoincrement())
  studentId Int @unique
  fatherName     String?
  motherName     String?
  guardianName   String
  phone          String
  email          String?
  occupation     String?
  annualIncome   Float?
  student        Student @relation(fields: [studentId], references: [id])
  createdAt      DateTime @default(now())

}

model AcademicSession {
  id        Int      @id @default(autoincrement())
  name      String   @unique   // e.g. 2025-2026
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  admissions StudentRegistration[]
}

model Section {
  id      Int    @id @default(autoincrement())
  name    String // A, B, C
  classId Int

  class   Classroom  @relation(fields: [classId], references: [id])
  admissions StudentRegistration[]

  @@unique([classId, name])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AdmissionStatus {
  APPLIED
  APPROVED
  REJECTED
}

enum DocumentType {
  AADHAR
  BIRTH_CERTIFICATE
  TRANSFER_CERTIFICATE
  OTHER
}

model StaffRegistration {
  id Int @id @default(autoincrement())

  user_id Int

  institution_id Int

  role_in_institution String?

  custom_data Json?

  user User @relation(fields: [user_id], references: [id])

  institution Institution @relation(fields: [institution_id], references: [id])

  staffAttendance StaffAttendance[]

  created_at DateTime @default(now())
}

model Classroom {
  id Int @id @default(autoincrement())

  name String

  subject String?

  description String?

  teacherId Int // Changed from String to Int to match User.id

  teacher User @relation(fields: [teacherId], references: [id])

  section Section[]

  student StudentRegistration[]

  students ClassroomStudent[]

  assignments Assignment[]

  studentAttendance StudentAttendance[]

  quizzes Quiz[]

  enquiry Enquiry[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt
}

model ClassroomStudent {
  id Int @id @default(autoincrement()) // Changed from String to Int

  classroom Classroom @relation(fields: [classroomId], references: [id])

  classroomId Int // Changed from String to Int to match Classroom.id

  student User @relation(fields: [studentId], references: [id])

  studentId Int // Changed from String to Int to match User.id
}

model Assignment {
  id Int @id @default(autoincrement()) // Changed from String to Int

  title String

  description String?

  dueDate DateTime

  classroom Classroom @relation(fields: [classroomId], references: [id])

  classroomId Int // Changed from String to Int to match Classroom.id

  createdBy String

  submissions Submission[]

  createdAt DateTime @default(now())

  updatedAt DateTime @updatedAt
}

model Submission {
  id Int @id @default(autoincrement()) // Changed from String to Int

  assignment Assignment @relation(fields: [assignmentId], references: [id])

  assignmentId Int // Changed from String to Int to match Assignment.id

  student User @relation(fields: [studentId], references: [id])

  studentId Int // Changed from String to Int to match User.id

  fileUrl String

  submittedAt DateTime @default(now())

  grade String?
}

enum FineType {
  FIXED
  PERCENTAGE
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

enum InstallmentType {
  MONTHLY
  TERM
  CUSTOM
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
  FAILED
}

enum PaymentMode {
  CASH
  BANK
  ONLINE
  CHEQUE
  UPI
}

enum LedgerEntryType {
  CHARGE // initial assignment/charge
  PAYMENT // payment received
  DISCOUNT // discount or scholarship applied
  FINE // late fee applied
  ADJUSTMENT // manual adjustments/refunds
}

model FeeHead {
  id             Int         @id @default(autoincrement())
  institution_id Int
  institution    Institution @relation(fields: [institution_id], references: [id], onDelete: Cascade)

  name           String
  code           String? // short code e.g. TUITION, TRANSPORT
  description    String?
  is_mandatory   Boolean  @default(true)
  default_amount Decimal? // recommended base value, optional
  currency       String?  @default("INR")

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  FeeStructureHead FeeStructureHead[]
  FeePaymentHead   FeePaymentHead[]
  FeeDiscounts     FeeDiscount[]
}

model FeeStructure {
  id             Int         @id @default(autoincrement())
  institution_id Int
  institution    Institution @relation(fields: [institution_id], references: [id], onDelete: Cascade)

  name        String
  code        String? // optional identifier for admin
  description String?
  phase_id    Int? // optional: applies to a Phase
  phase       Phase?    @relation(fields: [phase_id], references: [id], onDelete: SetNull)
  subgroup_id Int? // optional: applies to a SubGroup override
  subgroup    SubGroup? @relation(fields: [subgroup_id], references: [id], onDelete: SetNull)

  total_amount Decimal? // optional computed/summary amount
  currency     String?  @default("INR")
  is_active    Boolean  @default(true)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  heads        FeeStructureHead[]
  installments FeeInstallment[]
  discounts    FeeDiscount[]
  fine_rules   FeeFineRule[]
  assignments  FeeAssignment[]

  @@index([institution_id])
  @@index([phase_id])
  @@index([subgroup_id])
}

model FeeStructureHead {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  fee_head_id Int
  fee_head    FeeHead @relation(fields: [fee_head_id], references: [id], onDelete: Cascade)

  amount      Decimal
  is_optional Boolean @default(false) // optional heads e.g. transport
  notes       String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([fee_structure_id])
  @@index([fee_head_id])
}

model FeeInstallment {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  installment_no   Int // e.g., 1,2,3...
  installment_type InstallmentType
  due_date         DateTime
  amount           Decimal
  description      String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([fee_structure_id])
}

model FeeDiscount {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  name               String
  description        String?
  discount_type      DiscountType
  amount             Decimal // either fixed amount or percentage (interpreted by discount_type)
  applies_to_head_id Int? // nullable: if set, applies to specific FeeHead
  applies_to_head    FeeHead?     @relation(fields: [applies_to_head_id], references: [id], onDelete: SetNull)

  eligibility_criteria Json? // free-form JSON (e.g., {"sibling": true, "category": "SC"})
  valid_from           DateTime?
  valid_until          DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model FeeFineRule {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  name              String?
  description       String?
  fine_type         FineType // FIXED or PERCENTAGE
  value             Decimal // amount or percentage-per-day (interpretation depends on fine_type)
  grace_period_days Int      @default(0) // no fine within grace period
  max_cap           Decimal? // optional maximum cap for fines
  apply_after_days  Int? // optional: start applying after N days

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([fee_structure_id])
}

model FeeAssignment {
  id                      Int                 @id @default(autoincrement())
  student_registration_id Int
  student_registration    StudentRegistration @relation(fields: [student_registration_id], references: [id], onDelete: Cascade)

  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: SetNull)

  assigned_on    DateTime @default(now())
  assigned_by_id Int?
  assigned_by    User?    @relation("AssignedByUser", fields: [assigned_by_id], references: [id], onDelete: SetNull)

  total_amount       Decimal
  due_amount         Decimal
  outstanding_amount Decimal
  currency           String? @default("INR")

  status   PaymentStatus @default(PENDING)
  due_date DateTime?

  payments       FeePayment[]
  ledger_entries FeeLedger[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([student_registration_id])
  @@index([fee_structure_id])
}

model FeePayment {
  id                Int           @id @default(autoincrement())
  fee_assignment_id Int
  fee_assignment    FeeAssignment @relation(fields: [fee_assignment_id], references: [id], onDelete: Cascade)

  student_registration_id Int
  student_registration    StudentRegistration @relation(fields: [student_registration_id], references: [id], onDelete: Cascade)

  payment_date    DateTime      @default(now())
  amount          Decimal
  payment_mode    PaymentMode
  status          PaymentStatus @default(PENDING)
  transaction_ref String? // gateway/transaction id
  received_by_id  Int? // user id who recorded/received payment
  received_by     User?         @relation("ReceivedByUser", fields: [received_by_id], references: [id], onDelete: SetNull)
  note            String?

  // ðŸ§¾ Razorpay fields (add these)
  razorpay_order_id   String?
  razorpay_payment_id String?
  razorpay_signature  String?

  payment_heads FeePaymentHead[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([fee_assignment_id])
  @@index([student_registration_id])
}

model FeePaymentHead {
  id             Int        @id @default(autoincrement())
  fee_payment_id Int
  fee_payment    FeePayment @relation(fields: [fee_payment_id], references: [id], onDelete: Cascade)

  fee_head_id Int
  fee_head    FeeHead @relation(fields: [fee_head_id], references: [id], onDelete: SetNull)

  amount Decimal

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([fee_payment_id])
  @@index([fee_head_id])
}

model FeeLedger {
  id                Int           @id @default(autoincrement())
  fee_assignment_id Int
  fee_assignment    FeeAssignment @relation(fields: [fee_assignment_id], references: [id], onDelete: Cascade)

  entry_type    LedgerEntryType
  amount        Decimal
  balance_after Decimal? // optional snapshot of outstanding after this entry
  note          String?
  created_at    DateTime        @default(now())

  @@index([fee_assignment_id])
}

model StudentAttendance {
  id           Int              @id @default(autoincrement())
  studentRegId Int
  classroomId  Int
  status       AttendanceStatus @default(PRESENT)
  date         DateTime         @default(now())
  markedById   Int
  remarks      String?

  // Relations
  studentReg StudentRegistration @relation(fields: [studentRegId], references: [id])
  classroom  Classroom           @relation(fields: [classroomId], references: [id])
  markedBy   User                @relation(fields: [markedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentRegId, date, classroomId]) // prevent duplicate marking for same date & class
}

model StaffAttendance {
  id              Int               @id @default(autoincrement())
  staffRegId      Int
  institutionId   Int
  status          AttendanceStatus?
  punchInTime     DateTime          @default(now())
  punchOutTime    DateTime?
  punchInById     Int
  punchOutById    Int?
  punchInRemarks  String?
  punchOutRemarks String?

  // Relations
  staffReg    StaffRegistration @relation(fields: [staffRegId], references: [id])
  institution Institution       @relation(fields: [institutionId], references: [id])

  // Named relations (NO duplicates)
  punchInBy  User  @relation("PunchInByRelation", fields: [punchInById], references: [id])
  punchOutBy User? @relation("PunchOutByRelation", fields: [punchOutById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([staffRegId, punchInTime])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  EXCUSED
  HOLIDAY
}

model ChatRoom {
  id        Int          @id @default(autoincrement())
  type      ChatRoomType // DIRECT or GROUP
  name      String? // for group chats
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  createdBy    Int
  updatedBy    Int
  participants ChatParticipant[]
  messages     ChatMessage[]
}

enum ChatRoomType {
  DIRECT
  GROUP
}

model ChatParticipant {
  id         Int      @id @default(autoincrement())
  chatRoomId Int
  userId     Int
  joinedAt   DateTime @default(now())

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([chatRoomId, userId])
}

model ChatMessage {
  id          Int         @id @default(autoincrement())
  chatRoomId  Int
  senderId    Int
  content     String?
  messageType MessageType @default(TEXT)
  fileId      Int? // ðŸ‘ˆ link to file
  createdAt   DateTime    @default(now())

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id])
  sender   User     @relation(fields: [senderId], references: [id])
  file     File?    @relation(fields: [fileId], references: [id])
}

enum MessageType {
  TEXT
  IMAGE
  FILE
}

model File {
  id         Int      @id @default(autoincrement())
  name       String
  type       String // MIME type (image/png, application/pdf)
  size       Int // bytes
  data       Bytes? // ðŸ‘ˆ Binary now (later replace with url)
  url        String? // ðŸ‘ˆ Future AWS S3 URL
  uploadedAt DateTime @default(now())

  chatMessage ChatMessage[]
}

model Quiz {
  id              Int     @id @default(autoincrement())
  title           String
  description     String?
  durationSeconds Int
  totalMarks      Int     @default(0)
  isPublished     Boolean @default(false)

  createdById Int
  createdBy   User @relation("AdminQuizzes", fields: [createdById], references: [id])

  classroomId Int?
  classroom   Classroom? @relation(fields: [classroomId], references: [id])

  questions Question[]
  attempts  QuizAttempt[]

  created_at DateTime @default(now())
}

model Question {
  id     Int  @id @default(autoincrement())
  quizId Int
  quiz   Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionText String
  marks        Int    @default(1)

  options Option[]
  answers QuizAnswer[]

  created_at DateTime @default(now())
}

model Option {
  id         Int      @id @default(autoincrement())
  questionId Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  optionText String
  isCorrect  Boolean @default(false)

  answers QuizAnswer[] // âœ… required for Prisma
}

model QuizAttempt {
  id     Int  @id @default(autoincrement())
  quizId Int
  quiz   Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  studentId Int
  student   User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  startTime  DateTime
  endTime    DateTime?
  score      Int           @default(0)
  percentage Float?
  status     AttemptStatus

  answers QuizAnswer[]

  created_at DateTime @default(now())
}

model QuizAnswer {
  id        Int         @id @default(autoincrement())
  attemptId Int
  attempt   QuizAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId Int
  question   Question @relation(fields: [questionId], references: [id])

  selectedOptionId Int?
  selectedOption   Option? @relation(fields: [selectedOptionId], references: [id])

  isCorrect Boolean?
}

enum AttemptStatus {
  IN_PROGRESS
  SUBMITTED
  TIMED_OUT
}


model Enquiry {
  id                Int       @id @default(autoincrement())

  name              String
  phone             String
  email             String?
  address           String?
  description       String?

  status            EnquiryStatus @default(NEW)
  source            EnquirySource?

  enquiryDate       DateTime  @default(now())
  nextFollowUpDate  DateTime?

  assignedUserId    Int
  classroomId       Int

  assignedUser      User      @relation(fields: [assignedUserId], references: [id])
  classroom         Classroom @relation(fields: [classroomId], references: [id])

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}


enum EnquiryStatus {
  NEW
  CONTACTED
  FOLLOW_UP
  CONVERTED
  CLOSED
}

enum EnquirySource {
  WEBSITE
  WALK_IN
  PHONE
  WHATSAPP
  REFERRAL
}


model VisitorBook {
  id Int @id @default(autoincrement())
  purpose String 
  meetingWith MeetingWithRole @default(STAFF)
  visitorName String
  phone String
  idCard String
  numberOfPerson Int
  date DateTime
  inTime DateTime @default(now())
  outTime DateTime?
  note String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

enum MeetingWithRole{
  STAFF
  STUDENT
}

model Dispatch{
    id Int @id @default(autoincrement())
    referenceNo Int
    address String
    note String
    fromTitle String
    date DateTime
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt
}

model Receive{
    id Int @id @default(autoincrement())
    referenceNo Int
    address String
    note String
    toTitle String
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt
}

model Complain{
    id Int @id @default(autoincrement())
    complaint complaintType @default(MISBEHAVE)
    source String
    complainBy String
    phone String
    date DateTime @default(now())
    description String
    actionTaken String
    assign String
    note String
    isDeleted Boolean @default(false)
}

enum complaintType {
  EXAMLEAK
  MISBEHAVE
  ABUSE
}


