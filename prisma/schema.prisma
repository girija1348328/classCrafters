generator client {

Â  provider = "prisma-client-js"

}



datasource db {

Â  provider = "postgresql"

Â  urlÂ  Â  Â  = env("DATABASE_URL")

}



model Role {

Â  idÂ  Â  Â  Â  Â  IntÂ  Â  Â  @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  String

Â  description String?

Â  usersÂ  Â  Â  Â User[]

}



model User {

Â  idÂ  Â  Â  Â  Â  Â  IntÂ  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  String

Â  emailÂ  Â  Â  Â  Â StringÂ  Â  @unique

Â  password_hash String

Â  role_idÂ  Â  Â  Â Int

Â  roleÂ  Â  Â  Â  Â  RoleÂ  Â  Â  @relation(fields: [role_id], references: [id])

Â  studentRegsÂ  Â StudentRegistration[]

Â  staffRegsÂ  Â  Â StaffRegistration[]

Â  // Add these reverse relations

Â  classroomsÂ  Â  Classroom[]

Â  classroomStudents ClassroomStudent[]

Â  submissionsÂ  Â Submission[]

  assignedFeeAssignments FeeAssignment[] @relation("AssignedByUser")

  receivedPayments       FeePayment[]     @relation("ReceivedByUser")

  studentAttendance StudentAttendance[]

  punchIns    StaffAttendance[]  @relation("PunchInByRelation")
  punchOuts   StaffAttendance[]  @relation("PunchOutByRelation")

Â  created_atÂ  Â  DateTimeÂ  @default(now())

Â  updated_atÂ  Â  DateTimeÂ  @updatedAt

}



model EducationType {

Â  idÂ  Â  Â  Â  Â  Â  IntÂ  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  String

Â  institutionsÂ  Institution[]

}



model Location {

Â  idÂ  Â  Â  Â  Â  Â  IntÂ  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  String

Â  addressÂ  Â  Â  Â String?

Â  cityÂ  Â  Â  Â  Â  String?

Â  stateÂ  Â  Â  Â  Â String?

Â  countryÂ  Â  Â  Â String?

Â  zipcodeÂ  Â  Â  Â String?

Â  institutionsÂ  Institution[]

}



model Institution {

Â  idÂ  Â  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  Â  Â  Â String

Â  education_type_idÂ  Int

Â  location_idÂ  Â  Â  Â  Int

Â  educationTypeÂ  Â  Â  EducationTypeÂ  Â  Â  Â @relation(fields: [education_type_id], references: [id])

Â  locationÂ  Â  Â  Â  Â  Â LocationÂ  Â  Â  Â  Â  Â  @relation(fields: [location_id], references: [id])

Â  studentRegsÂ  Â  Â  Â  StudentRegistration[]

Â  staffRegsÂ  Â  Â  Â  Â  StaffRegistration[]

  feeHeads           FeeHead[]
  
  feeStructures      FeeStructure[]

  staffAttendance    StaffAttendance[]

Â  created_atÂ  Â  Â  Â  Â DateTime @default(now())

Â  updated_atÂ  Â  Â  Â  Â DateTime @updatedAt

   

}



model Phase {

Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  Â  Â String

Â  descriptionÂ  Â  Â  String?

Â  studentRegsÂ  Â  Â  StudentRegistration[]

feeStructures FeeStructure[]

}



model MainGroup {

Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  Â  Â String

Â  descriptionÂ  Â  Â  String?

Â  subGroupsÂ  Â  Â  Â  SubGroup[]

}



model SubGroup {

Â  idÂ  Â  Â  Â  Â  Â  Â  Â IntÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  Â  Â  Â String

Â  main_group_idÂ  Â  Int

Â  mainGroupÂ  Â  Â  Â  MainGroupÂ  Â  Â  Â  Â  Â  Â  @relation(fields: [main_group_id], references: [id])

Â  studentRegsÂ  Â  Â  StudentRegistration[]

  feeStructures FeeStructure[]

}



model CustomField {

Â  idÂ  Â  Â  Â  Â  IntÂ  Â  Â  @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  String

Â  entity_type StringÂ  Â // "student_registration" or "staff_registration"

Â  field_typeÂ  StringÂ  Â // text, number, date, dropdown

Â  optionsÂ  Â  Â Json?

}



model StudentRegistration {

Â  idÂ  Â  Â  Â  Â  Â  IntÂ  Â  Â  Â @id @default(autoincrement())

Â  user_idÂ  Â  Â  Â Int

Â  institution_id Int

Â  phase_idÂ  Â  Â  Int

Â  subgroup_idÂ  Â Int

Â  custom_dataÂ  Â Json?

Â  userÂ  Â  Â  Â  Â  UserÂ  Â  Â  @relation(fields: [user_id], references: [id])

Â  institutionÂ  Â Institution @relation(fields: [institution_id], references: [id])

Â  phaseÂ  Â  Â  Â  Â PhaseÂ  Â  Â @relation(fields: [phase_id], references: [id])

Â  subgroupÂ  Â  Â  SubGroupÂ  @relation(fields: [subgroup_id], references: [id])
 
  feeAssignments FeeAssignment[]

  feePayments    FeePayment[]

  studentAttendance StudentAttendance[]

Â  created_atÂ  Â  DateTimeÂ  @default(now())

}



model StaffRegistration {

Â  idÂ  Â  Â  Â  Â  Â  Â  IntÂ  Â  Â  Â @id @default(autoincrement())

Â  user_idÂ  Â  Â  Â  Â Int

Â  institution_idÂ  Int

Â  role_in_institution String?

Â  custom_dataÂ  Â  Â Json?

Â  userÂ  Â  Â  Â  Â  Â  UserÂ  Â  Â  Â @relation(fields: [user_id], references: [id])

Â  institutionÂ  Â  Â Institution @relation(fields: [institution_id], references: [id])

  staffAttendance    StaffAttendance[]

Â  created_atÂ  Â  Â  DateTimeÂ  Â @default(now())

}



model Classroom {

Â  idÂ  Â  Â  Â  Â  IntÂ  Â  Â  Â  @id @default(autoincrement())

Â  nameÂ  Â  Â  Â  String

Â  subjectÂ  Â  Â String?

Â  description String?

Â  teacherIdÂ  Â IntÂ  // Changed from String to Int to match User.id

Â  teacherÂ  Â  Â UserÂ  Â  Â  Â  Â  @relation(fields: [teacherId], references: [id])

Â  studentsÂ  Â  ClassroomStudent[]

Â  assignments Assignment[]

  studentAttendance StudentAttendance[]

Â  createdAtÂ  Â DateTimeÂ  Â  Â  @default(now())

Â  updatedAtÂ  Â DateTimeÂ  Â  Â  @updatedAt

}



model ClassroomStudent {

Â  idÂ  Â  Â  Â  Â  IntÂ  Â  @id @default(autoincrement())Â  // Changed from String to Int

Â  classroomÂ  Â Classroom @relation(fields: [classroomId], references: [id])

Â  classroomId IntÂ  // Changed from String to Int to match Classroom.id

Â  studentÂ  Â  Â UserÂ  Â  Â  @relation(fields: [studentId], references: [id])

Â  studentIdÂ  Â IntÂ  // Changed from String to Int to match User.id

}



model Assignment {

Â  idÂ  Â  Â  Â  Â  IntÂ  Â  @id @default(autoincrement())Â  // Changed from String to Int

Â  titleÂ  Â  Â  Â String

Â  description String?

Â  dueDateÂ  Â  Â DateTime

Â  classroomÂ  Â Classroom @relation(fields: [classroomId], references: [id])

Â  classroomId IntÂ  // Changed from String to Int to match Classroom.id

Â  createdByÂ  Â String

Â  submissions Submission[]

Â  createdAtÂ  Â DateTimeÂ  @default(now())

Â  updatedAtÂ  Â DateTimeÂ  @updatedAt

}



model Submission {

Â  idÂ  Â  Â  Â  Â  Â IntÂ  Â  Â @id @default(autoincrement())Â  // Changed from String to Int

Â  assignmentÂ  Â Assignment @relation(fields: [assignmentId], references: [id])

Â  assignmentId IntÂ  // Changed from String to Int to match Assignment.id

Â  studentÂ  Â  Â  UserÂ  Â  Â  Â @relation(fields: [studentId], references: [id])

Â  studentIdÂ  Â  IntÂ  // Changed from String to Int to match User.id

Â  fileUrlÂ  Â  Â  String

Â  submittedAtÂ  DateTimeÂ  Â @default(now())

Â  gradeÂ  Â  Â  Â  String?

}

enum FineType {
  FIXED
  PERCENTAGE
}

enum DiscountType {
  FIXED
  PERCENTAGE
}

enum InstallmentType {
  MONTHLY
  TERM
  CUSTOM
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  CANCELLED
  FAILED
}

enum PaymentMode {
  CASH
  BANK
  ONLINE
  CHEQUE
  UPI
}

enum LedgerEntryType {
  CHARGE      // initial assignment/charge
  PAYMENT     // payment received
  DISCOUNT    // discount or scholarship applied
  FINE        // late fee applied
  ADJUSTMENT  // manual adjustments/refunds
}

model FeeHead {
  id             Int         @id @default(autoincrement())
  institution_id Int
  institution    Institution @relation(fields: [institution_id], references: [id], onDelete: Cascade)

  name           String
  code           String?     // short code e.g. TUITION, TRANSPORT
  description    String?
  is_mandatory   Boolean     @default(true)
  default_amount Decimal?    // recommended base value, optional
  currency       String?     @default("INR")

  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt 

  FeeStructureHead FeeStructureHead[]
  FeePaymentHead   FeePaymentHead[]
  FeeDiscounts    FeeDiscount[]
}

model FeeStructure {
  id              Int         @id @default(autoincrement())
  institution_id  Int
  institution     Institution @relation(fields: [institution_id], references: [id], onDelete: Cascade)

  name            String
  code            String?      // optional identifier for admin
  description     String?
  phase_id        Int?         // optional: applies to a Phase
  phase           Phase?       @relation(fields: [phase_id], references: [id], onDelete: SetNull)
  subgroup_id     Int?         // optional: applies to a SubGroup override
  subgroup        SubGroup?    @relation(fields: [subgroup_id], references: [id], onDelete: SetNull)

  total_amount    Decimal?     // optional computed/summary amount
  currency        String?      @default("INR")
  is_active       Boolean      @default(true)

  created_at      DateTime     @default(now())
  updated_at      DateTime     @updatedAt

  heads           FeeStructureHead[]
  installments    FeeInstallment[]
  discounts       FeeDiscount[]
  fine_rules      FeeFineRule[]
  assignments     FeeAssignment[]

  @@index([institution_id])
  @@index([phase_id])
  @@index([subgroup_id])
}

model FeeStructureHead {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  fee_head_id      Int
  fee_head         FeeHead      @relation(fields: [fee_head_id], references: [id], onDelete: Cascade)

  amount           Decimal
  is_optional      Boolean      @default(false) // optional heads e.g. transport
  notes            String?

  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@index([fee_structure_id])
  @@index([fee_head_id])
}

model FeeInstallment {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  installment_no   Int          // e.g., 1,2,3...
  installment_type InstallmentType
  due_date         DateTime
  amount           Decimal
  description      String?

  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@index([fee_structure_id])
}

model FeeDiscount {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  name             String
  description      String?
  discount_type    DiscountType
  amount           Decimal      // either fixed amount or percentage (interpreted by discount_type)
  applies_to_head_id Int?       // nullable: if set, applies to specific FeeHead
  applies_to_head  FeeHead?     @relation(fields: [applies_to_head_id], references: [id], onDelete: SetNull)

  eligibility_criteria Json?    // free-form JSON (e.g., {"sibling": true, "category": "SC"})
  valid_from       DateTime?
  valid_until      DateTime?

  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

}

model FeeFineRule {
  id               Int          @id @default(autoincrement())
  fee_structure_id Int
  fee_structure    FeeStructure @relation(fields: [fee_structure_id], references: [id], onDelete: Cascade)

  name             String?
  description      String?
  fine_type        FineType     // FIXED or PERCENTAGE
  value            Decimal      // amount or percentage-per-day (interpretation depends on fine_type)
  grace_period_days Int         @default(0) // no fine within grace period
  max_cap          Decimal?     // optional maximum cap for fines
  apply_after_days Int?         // optional: start applying after N days

  created_at       DateTime     @default(now())
  updated_at       DateTime     @updatedAt

  @@index([fee_structure_id])
}

model FeeAssignment {
  id                     Int                  @id @default(autoincrement())
  student_registration_id Int
  student_registration   StudentRegistration  @relation(fields: [student_registration_id], references: [id], onDelete: Cascade)

  fee_structure_id       Int
  fee_structure          FeeStructure         @relation(fields: [fee_structure_id], references: [id], onDelete: SetNull)

  assigned_on            DateTime             @default(now())
  assigned_by_id         Int?
  assigned_by            User?                @relation("AssignedByUser", fields: [assigned_by_id], references: [id], onDelete: SetNull)

  total_amount           Decimal
  due_amount             Decimal
  outstanding_amount     Decimal
  currency               String?              @default("INR")

  status                 PaymentStatus        @default(PENDING)
  due_date               DateTime?

  payments               FeePayment[]
  ledger_entries         FeeLedger[]

  created_at             DateTime             @default(now())
  updated_at             DateTime             @updatedAt

  @@index([student_registration_id])
  @@index([fee_structure_id])
}


model FeePayment {
  id                    Int           @id @default(autoincrement())
  fee_assignment_id     Int
  fee_assignment        FeeAssignment @relation(fields: [fee_assignment_id], references: [id], onDelete: Cascade)

  student_registration_id Int
  student_registration  StudentRegistration @relation(fields: [student_registration_id], references: [id], onDelete: Cascade)

  payment_date          DateTime      @default(now())
  amount                Decimal
  payment_mode          PaymentMode
  status                PaymentStatus @default(PENDING)
  transaction_ref       String?       // gateway/transaction id
  received_by_id        Int?          // user id who recorded/received payment
  received_by           User? @relation("ReceivedByUser", fields: [received_by_id], references: [id], onDelete: SetNull)
  note                  String?

   // ðŸ§¾ Razorpay fields (add these)
  razorpay_order_id      String?
  razorpay_payment_id    String?
  razorpay_signature     String?

  payment_heads         FeePaymentHead[]

  created_at            DateTime      @default(now())
  updated_at            DateTime      @updatedAt

  @@index([fee_assignment_id])
  @@index([student_registration_id])
}

model FeePaymentHead {
  id               Int       @id @default(autoincrement())
  fee_payment_id   Int
  fee_payment      FeePayment @relation(fields: [fee_payment_id], references: [id], onDelete: Cascade)

  fee_head_id      Int
  fee_head         FeeHead    @relation(fields: [fee_head_id], references: [id], onDelete: SetNull)

  amount           Decimal

  created_at       DateTime   @default(now())
  updated_at       DateTime   @updatedAt

  @@index([fee_payment_id])
  @@index([fee_head_id])
}

model FeeLedger {
  id                  Int           @id @default(autoincrement())
  fee_assignment_id   Int
  fee_assignment      FeeAssignment @relation(fields: [fee_assignment_id], references: [id], onDelete: Cascade)

  entry_type          LedgerEntryType
  amount              Decimal
  balance_after       Decimal?      // optional snapshot of outstanding after this entry
  note                String?
  created_at          DateTime      @default(now())

  @@index([fee_assignment_id])
}

model StudentAttendance {
  id               Int                  @id @default(autoincrement())
  studentRegId     Int
  classroomId      Int
  status           AttendanceStatus     @default(PRESENT)
  date             DateTime             @default(now())
  markedById       Int
  remarks          String?

  // Relations
  studentReg       StudentRegistration  @relation(fields: [studentRegId], references: [id])
  classroom        Classroom            @relation(fields: [classroomId], references: [id])
  markedBy         User                 @relation(fields: [markedById], references: [id])

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@unique([studentRegId, date, classroomId]) // prevent duplicate marking for same date & class
}

model StaffAttendance {
  id               Int                  @id @default(autoincrement())
  staffRegId       Int
  institutionId    Int
  status           AttendanceStatus?
  punchInTime      DateTime             @default(now())
  punchOutTime     DateTime?            // time student checked out
  punchInById      Int                  // e.g., admin/principal
  punchOutById     Int?
  punchInRemarks          String?
  punchOutRemarks         String?

  // Relations
  staffReg         StaffRegistration    @relation(fields: [staffRegId], references: [id])
  institution      Institution          @relation(fields: [institutionId], references: [id])

// FIX: Add relation names here
  punchInBy        User              @relation("PunchInBy", fields: [punchInById], references: [id])
  punchOutBy       User              @relation("PunchOutBy", fields: [punchOutById], references: [id])

  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@unique([staffRegId, punchInTime]) // ensure one record per staff per day
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  EXCUSED
  HOLIDAY
}
